{% extends "user/user_layout.html" %}

{% block user_title %}My Favorites{% endblock %}

{% block extra_styles %}
<style>
    .page-header { text-align: center; margin-bottom: 30px; }
    .page-header h2 { margin-top: 0; color: var(--dark-text); font-size: 2rem; }
    .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
    .dest-card { background-color: var(--white); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; position: relative; }
    .dest-card-img { width: 100%; height: 180px; object-fit: cover; }
    .dest-card-content { padding: 20px; flex-grow: 1; }
    .dest-card h3 { margin-top: 0; font-size: 1.25rem; }
    .dest-card .location { color: var(--secondary-color); font-weight: 500; margin-bottom: 15px; }
    .dest-card-footer { padding: 15px 20px; background-color: var(--light-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
    .empty-state { text-align: center; padding: 50px; background-color: var(--white); border-radius: 12px; box-shadow: var(--shadow); }
    .empty-state i { font-size: 3rem; color: #ccc; margin-bottom: 20px; }
    .empty-state h3 { color: var(--dark-text); }
    .empty-state p { color: var(--secondary-color); }
    .empty-state a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
    
    .favorite-btn { position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #ff4d4d; font-size: 1.2rem; transition: transform 0.2s, color 0.2s; z-index: 10; }
    .favorite-btn:hover { transform: scale(1.1); }
    .favorite-btn i { pointer-events: none; }
    
    .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
    .status-badge.safe { background-color: #d4edda; color: #155724; }
    .status-badge.caution { background-color: #fff3cd; color: #856404; }
    .status-badge.unsafe { background-color: #f8d7da; color: #721c24; }
</style>
{% endblock %}

{% block user_content %}
<div class="page-header">
    <h2><i class="fas fa-heart"></i> My Favorite Destinations</h2>
</div>

{% if destinations %}
    <div class="results-grid" id="favoritesGrid">
        {% for dest in destinations %}
            <div class="dest-card" id="dest-card-{{ dest.Destination_id }}">

                <button class="favorite-btn" data-id="{{ dest.Destination_id }}" title="Remove from Favorites">
                    <i class="fas fa-heart"></i>
                </button>
                
                {% if dest.image_url %}
                <img src="{{ dest.image_url }}" alt="{{ dest.Place }}" class="dest-card-img">
                {% endif %}

                <div class="dest-card-content">
                    <h3>{{ dest.Place }}</h3>
                    <p class="location"><i class="fas fa-map-marker-alt"></i> {{ dest.Name }} • {{ dest.Type|capitalize }}</p>
                </div>
                <div class="dest-card-footer">
                    <span>Budget: ₹{{ "{:,.0f}".format(dest.budget|int) if dest.budget else 'N/A' }}</span>
                    <!-- MODIFIED: Use the consistent safety_info property -->
                    <span class="status-badge {{ dest.safety_info.class }}">{{ dest.safety_info.text }}</span>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-heart-broken"></i>
        <h3>No Favorites Yet</h3>
        <p>You haven't added any destinations to your favorites. Start exploring to find places you love!</p>
        <a href="{{ url_for('views.search') }}">Explore Destinations</a>
    </div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const favoritesGrid = document.getElementById('favoritesGrid');
    
    if (favoritesGrid) {
        favoritesGrid.addEventListener('click', async function (event) {
            const button = event.target.closest('.favorite-btn');
            if (!button) return;

            event.stopPropagation();
            const destId = button.dataset.id;
            
            try {
                const response = await fetch(`/api/favorites/remove/${destId}`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    const cardToRemove = document.getElementById(`dest-card-${destId}`);
                    if (cardToRemove) {
                        cardToRemove.style.transition = 'opacity 0.5s';
                        cardToRemove.style.opacity = '0';
                        setTimeout(() => {
                            cardToRemove.remove();
                            if (favoritesGrid.children.length === 0) {
                                window.location.reload(); // Reload to show empty state message
                            }
                        }, 500);
                    }
                } else {
                    alert(result.message || 'Could not remove from favorites.');
                }
            } catch (error) {
                console.error('Favorite remove error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    }
});
</script>
{% endblock %}